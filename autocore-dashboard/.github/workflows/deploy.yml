name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting
      run: npm run lint
      
    - name: Build application
      run: npm run build
      env:
        NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
        
    - name: Create deployment directory
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        script: |
          mkdir -p /var/www/autocore-dashboard
          mkdir -p /var/www/autocore-dashboard/backup
          
    - name: Backup existing deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        script: |
          if [ -d "/var/www/autocore-dashboard/.next" ]; then
            cp -r /var/www/autocore-dashboard/.next /var/www/autocore-dashboard/backup/.next-$(date +%Y%m%d-%H%M%S)
          fi
          
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        script: |
          cd /var/www/autocore-dashboard
          
          # Install PM2 globally if not already installed
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi
          
          # Stop existing PM2 process if running
          pm2 stop autocore-dashboard 2>/dev/null || true
          pm2 delete autocore-dashboard 2>/dev/null || true
          
    - name: Copy files to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        source: ".next,package.json,package-lock.json,public,next.config.js"
        target: "/var/www/autocore-dashboard"
        strip_components: 0
        
    - name: Install production dependencies and start application
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        script: |
          cd /var/www/autocore-dashboard
          
          # Install production dependencies
          npm ci --only=production
          
          # Start the application with PM2
          pm2 start npm --name "autocore-dashboard" -- start
          
          # Save PM2 configuration
          pm2 save
          pm2 startup
          
          # Setup nginx reverse proxy if not exists
          if [ ! -f "/etc/nginx/sites-available/autocore-dashboard" ]; then
            cat > /etc/nginx/sites-available/autocore-dashboard << 'EOF'
server {
    listen 80;
    server_name 168.231.101.119;

    location / {
        proxy_pass https://api.aakodessewa.com/:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF
            
            # Enable the site
            ln -sf /etc/nginx/sites-available/autocore-dashboard /etc/nginx/sites-enabled/
            
            # Test and reload nginx
            nginx -t && systemctl reload nginx
          fi
          
    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        script: |
          echo "=== PM2 Status ==="
          pm2 status
          echo "=== Application Logs ==="
          pm2 logs autocore-dashboard --lines 10
          echo "=== Nginx Status ==="
          systemctl status nginx --no-pager
